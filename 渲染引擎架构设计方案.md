# 混合模式低代码渲染引擎架构设计方案

## 项目概述

本项目旨在构建一个企业级的混合模式低代码渲染引擎，通过声明式的 JSON Schema 实现页面的动态渲染和交互。该引擎采用**智能混合模式**，平衡性能与灵活性，既保证快速的初始加载，又提供强大的动态交互能力。

## 核心架构：四层分离模型

### 架构总览

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Browser)                       │
├─────────────────────────────────────────────────────────────┤
│  前端渲染器层 (Frontend Renderer Layer)                     │
│  - JSON解析器、组件渲染器、状态管理器                        │
│  - 数据加载器、行为执行器、加载策略管理器                     │
├─────────────────────────────────────────────────────────────┤
│  前端UI组件层 (Frontend UI Component Layer)                 │
│  - 纯粹、可复用的UI组件库 (React/Vue)                       │
└─────────────────────────────────────────────────────────────┘
                                ↕ JSON + Data APIs
┌─────────────────────────────────────────────────────────────┐
│                        后端 (Server)                        │
├─────────────────────────────────────────────────────────────┤
│  UI合成器层 (UI Composer Layer)                             │
│  - 根据页面ID动态构建并下发页面结构的JSON                    │
├─────────────────────────────────────────────────────────────┤
│  后端数据层 (Backend Data Layer)                            │
│  - 提供与UI无关的纯粹业务数据API                             │
└─────────────────────────────────────────────────────────────┘
```

### 各层职责详解

#### 1. 前端UI组件层 (Frontend UI Component Layer)
- **核心职责**: 提供原子化、高内聚、可复用的UI组件库
- **特点**: 纯粹性 - 只根据props渲染UI，不包含业务逻辑、数据请求或状态管理
- **示例**: `<Button>`, `<DataTable>`, `<Modal>`, `<Form>` 等

#### 2. 前端渲染器层 (Frontend Renderer Layer)
- **核心职责**: 整个前端应用的"大脑"，将JSON定义变为可交互界面
- **子模块**:
  - **JSON解析器**: 解析UI合成器下发的页面JSON
  - **组件渲染器**: 递归渲染JSON中的组件树
  - **状态管理器**: 全局响应式状态池 (Redux/Zustand)
  - **数据加载器**: 根据loadStrategy调用后端数据API
  - **行为执行器**: 监听事件，执行actions中定义的逻辑
  - **加载策略管理器**: 实现智能混合加载模式

#### 3. UI合成器层 (UI Composer Layer)
- **核心职责**: 后端微服务，根据请求动态生成页面结构JSON
- **特点**: 定义页面蓝图，不提供具体业务数据
- **接口**: `GET /api/ui-composer/v1/page?name=dashboard`

#### 4. 后端数据层 (Backend Data Layer)
- **核心职责**: 提供纯粹的、与UI无关的业务数据接口
- **特点**: UI无关性，专注业务逻辑处理
- **示例**: `GET /api/data/v1/users`, `POST /api/data/v1/orders`

## JSON Schema 设计规范

### 顶层结构

```typescript
interface PageSchema {
  metadata: Metadata;           // 页面元信息
  loadStrategy: LoadStrategy;   // 加载策略
  layout: Layout;               // 页面布局
  components: Record<string, ComponentDefinition>;  // 组件字典
  dataSource: Record<string, DataSourceDefinition>; // 数据源中心
  actions: Record<string, ActionDefinition>;        // 行为中心
  initialState: Record<string, any>;                // 初始状态
  
  // 高级特性
  computed: Record<string, ComputedDefinition>;     // 计算属性
  templates: Record<string, TemplateDefinition>;    // 组件模板
  lifecycle: LifecycleDefinition;                   // 生命周期
}
```

### 1. metadata - 页面元信息

```json
{
  "metadata": {
    "pageId": "pg_user_dashboard_v2",
    "name": "用户看板",
    "version": "1.0.2",
    "description": "展示核心用户数据和活动列表",
    "seo": {
      "title": "我的看板",
      "keywords": "看板, 用户数据"
    }
  }
}
```

### 2. loadStrategy - 智能混合加载策略

```json
{
  "loadStrategy": {
    "initial": ["ds_user_profile", "comp_page_header"],
    "preload": ["comp_user_details_modal"],
    "onDemand": {
      "act_open_details_modal": ["ds_user_details_api", "comp_user_details_modal"]
    }
  }
}
```

### 3. layout & components - 布局系统

**扁平化字典 + 嵌套引用模式**

```json
{
  "layout": {
    "root": "comp_root_container",
    "slots": {
      "header": "comp_page_header",
      "footer": "comp_global_footer"
    }
  },
  "components": {
    "comp_root_container": {
      "componentType": "PageContainer",
      "properties": { "style": { "padding": "16px" } },
      "children": ["comp_user_table", "comp_load_button"]
    },
    "comp_user_table": {
      "componentType": "DataTable",
      "properties": {
        "columns": [
          { "key": "name", "title": "姓名" },
          { "key": "email", "title": "邮箱" }
        ]
      },
      "dataBinding": {
        "tableData": "state.userList"
      },
      "visibility": "{{state.currentUser.hasPermission('view_users')}}",
      "dynamicProps": {
        "loading": "{{state.isLoading}}"
      }
    }
  }
}
```

### 4. dataSource - 数据源中心

```json
{
  "dataSource": {
    "ds_user_list_api": {
      "type": "API_REQUEST",
      "config": {
        "url": "/api/data/v1/users",
        "method": "GET",
        "params": { "limit": 10 }
      },
      "onSuccess": "act_update_user_list",
      "onError": "act_show_error_message"
    },
    "ds_static_welcome": {
      "type": "STATIC_DATA",
      "value": "欢迎回来！"
    }
  }
}
```

### 5. actions - 行为与逻辑中心

```json
{
  "actions": {
    "act_fetch_users": {
      "type": "COMPOSITE",
      "steps": ["act_set_loading_true", "act_call_user_api", "act_set_loading_false"]
    },
    "act_call_user_api": {
      "type": "FETCH_DATA",
      "dataSourceId": "ds_user_list_api"
    },
    "act_update_user_list": {
      "type": "UPDATE_STATE",
      "payload": {
        "path": "userList",
        "value": "{{response.data}}"
      }
    }
  }
}
```

### 6. 高级特性

#### 计算属性 (computed)
```json
{
  "computed": {
    "formattedOrders": {
      "dependencies": ["state.orders"],
      "expression": "{{state.orders.map(order => ({ ...order, price: formatCurrency(order.price) }))}}"
    }
  }
}
```

#### 校验系统 (validations)
```json
{
  "initialState": {
    "formData": {
      "email": {
        "value": "",
        "validations": [
          { "type": "required", "message": "邮箱不能为空" },
          { "type": "pattern", "value": "^\\S+@\\S+\\.\\S+$", "message": "邮箱格式不正确" }
        ]
      }
    }
  }
}
```

#### 组件模板 (templates)
```json
{
  "templates": {
    "UserCardTemplate": {
      "componentType": "Card",
      "properties": { "shadow": "medium" },
      "slots": ["header", "body", "actions"],
      "children": [
        { "componentType": "Slot", "properties": { "name": "header" } },
        { "componentType": "Slot", "properties": { "name": "body" } },
        { "componentType": "Slot", "properties": { "name": "actions" } }
      ]
    }
  }
}
```

#### 生命周期钩子 (lifecycle)
```json
{
  "lifecycle": {
    "onLoad": ["act_fetch_initial_data", "act_report_page_view"],
    "onUnload": ["act_cleanup_timers"]
  }
}
```

## 数据流转机制

### 初始化流程
1. **解析加载策略** → 读取 `loadStrategy.initial`
2. **识别初始组件** → 从 `components` 字典找到需要立即加载的组件
3. **收集数据依赖** → 读取组件的 `dataBinding`，收集 `dataSource` ID
4. **并行获取数据** → `Promise.allSettled` 并行获取数据
5. **注入状态中心** → 数据存入全局状态管理器
6. **组件渲染** → 组件通过 `dataBinding` 订阅数据并渲染

### 事件驱动流程
1. **事件触发** → 用户交互触发组件的 `events.onClick`
2. **动作查找与执行** → 行为执行器根据 action ID 执行逻辑
3. **数据获取** → 调用 `dataSource` 模块执行 API 请求
4. **状态更新** → 执行器更新中心状态管理器的数据
5. **UI自动更新** → 订阅数据的组件自动重新渲染

## 技术栈与实现要点

### 前端技术栈
- **UI框架**: React 18+ (支持并发特性)
- **状态管理**: Zustand / Redux Toolkit
- **表达式引擎**: Jexl / 自定义实现
- **构建工具**: Vite / Webpack
- **类型系统**: TypeScript 5+

### 核心实现要点

#### 1. 组件注册表
```typescript
class ComponentRegistry {
  private components = new Map<string, React.ComponentType<any>>();
  
  register(type: string, component: React.ComponentType<any>) {
    this.components.set(type, component);
  }
  
  get(type: string) {
    return this.components.get(type);
  }
}
```

#### 2. 动态渲染器
```typescript
function ComponentRenderer({ componentSchema }: { componentSchema: ComponentDefinition }) {
  const ComponentImplementation = componentRegistry.get(componentSchema.componentType);
  const data = useDataSubscription(componentSchema.dataBinding);
  const actions = useActionDispatch(componentSchema.events);
  
  if (!ComponentImplementation) {
    return <Error message={`Component ${componentSchema.componentType} not found`} />;
  }
  
  return <ComponentImplementation {...componentSchema.properties} {...data} {...actions} />;
}
```

#### 3. 表达式求值引擎
```typescript
class ExpressionEngine {
  evaluate(expression: string, context: Record<string, any>): any {
    // 解析 {{expression}} 语法
    // 支持 state.xxx, theme.xxx, t('key') 等内置函数
  }
}
```

## 性能优化策略

1. **按需加载**: 基于 `loadStrategy` 实现组件和数据的懒加载
2. **虚拟滚动**: 大列表组件支持虚拟滚动
3. **缓存机制**: 组件定义、数据请求结果的智能缓存
4. **Bundle分割**: 按组件类型进行代码分割
5. **预加载**: 利用浏览器空闲时间预加载可能用到的资源

## 扩展性设计

1. **插件系统**: 支持自定义组件、数据源类型、action类型的注册
2. **主题系统**: 通过 Design Tokens 实现主题的动态切换
3. **国际化**: 内置 i18n 支持，表达式中可使用 `t()` 函数
4. **调试工具**: 开发模式下提供可视化的状态查看和调试工具

---

*本方案为混合模式低代码渲染引擎的核心架构设计，后续将基于此方案进行详细的技术实现。* 